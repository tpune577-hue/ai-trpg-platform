// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// --- USER & AUTH (Modified for NextAuth) ---
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?   // รูป Profile จาก Google
  
  // NextAuth Relations
  accounts      Account[]
  sessions      Session[]

  // App Specific Relations
  createdCampaigns Campaign[] 
  ownedCampaigns   Purchase[] 
  receivedReviews  Review[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ✅ Model มาตรฐานสำหรับ NextAuth (Account)
model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String? 
  access_token       String? 
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String? 
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

// ✅ Model มาตรฐานสำหรับ NextAuth (Session)
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ✅ Model มาตรฐานสำหรับ NextAuth (VerificationToken)
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// --- CAMPAIGN TEMPLATE (สินค้า/ต้นฉบับ) ---
model Campaign {
  id          String   @id @default(cuid())
  
  // Basic Info
  title       String
  description String? 
  coverImage  String?
  tags        String? 
  
  // ✅ Game System
  system      String   @default("STANDARD") 

  // Story Details
  storyIntro  String? 
  storyMid    String? 
  storyEnd    String? 

  // Marketplace Fields
  isPublished Boolean  @default(false)
  price       Int      @default(0) 
  
  // Assets
  scenes      Scene[]
  npcs        Npc[]
  items       Item[]
  preGens     PreGenCharacter[] 
  
  // Relations
  creatorId   String
  creator     User      @relation(fields: [creatorId], references: [id])
  purchases   Purchase[]
  sessions    GameSession[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
}

// --- ASSETS ---
model Scene {
  id          String   @id @default(cuid())
  name        String
  imageUrl    String
  description String?
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

model Npc {
  id          String   @id @default(cuid())
  name        String
  avatarUrl   String
  type        String    // FRIENDLY, ENEMY, NEUTRAL
  stats       String?   // JSON string { hp: 10, str: 10 ... }
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

model Item {
  id          String   @id @default(cuid())
  name        String
  description String?
  type        String    // WEAPON, POTION, KEY_ITEM
  icon        String?
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

model PreGenCharacter {
  id          String   @id @default(cuid())
  name        String
  bio         String?
  avatarUrl   String?
  sheetType   String   @default("STANDARD")
  stats       String?   // JSON string
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

// --- MARKETPLACE TRANSACTION ---
model Purchase {
  id          String   @id @default(cuid())
  userId      String
  campaignId  String
  purchasedAt DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id])
  campaign    Campaign @relation(fields: [campaignId], references: [id])

  @@unique([userId, campaignId]) 
}

// --- GAME SESSION (ห้องเล่นจริง) ---
model GameSession {
  id              String   @id @default(cuid())
  joinCode        String   @unique 
  status          String   @default("WAITING") 
  
  // Current State
  currentSceneId  String?
  activeNpcs      String?  // JSON Array String
  
  // Lobby Settings
  isAiGm          Boolean  @default(false)

  // Campaign 
  campaignId      String?
  campaign        Campaign? @relation(fields: [campaignId], references: [id])
  
  players         Player[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now()) @updatedAt
}

model Player {
  id            String      @id @default(cuid())
  name          String
  role          String      @default("PLAYER")
  isReady       Boolean     @default(false)
  sheetType     String      @default("STANDARD")
  
  characterData String?     
  preGenId      String?
  
  sessionId     String
  session       GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  createdAt     DateTime    @default(now()) 
}

// --- REVIEWS & FEEDBACK ---
model Review {
  id             String   @id @default(cuid())
  rating         Int      // 0-5
  comment        String?
  reviewerName   String   // ชื่อ Player ที่รีวิว
  
  // เชื่อมกับ GM (User)
  targetUserId   String
  targetUser     User     @relation(fields: [targetUserId], references: [id])

  sessionCode    String?

  createdAt      DateTime @default(now())
}