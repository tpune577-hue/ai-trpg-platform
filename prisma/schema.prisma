// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// --- USER & AUTH (Modified for NextAuth) ---
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?   // รูป Profile จาก Google
  
  // Role: "USER", "GM", "ADMIN"
  role          String    @default("USER")

// ✅ Ban feature
  bannedUntil   DateTime? // วันที่ปลดแบน (ถ้าเป็น null แปลว่าปกติ, ถ้ามีค่าและยังไม่ถึง = โดนแบน)
  banReason     String?   // เหตุผลที่แบน

  // NextAuth Relations
  accounts      Account[]
  sessions      Session[]

  // App Specific Relations
  createdCampaigns Campaign[] 
  ownedCampaigns   Purchase[] 
  receivedReviews  Review[]
  
  // Seller Profile (สำหรับรับเงิน/ขายของ)
  sellerProfile    SellerProfile?

  // ✅ Marketplace Relations (เพิ่มใหม่)
  orders           Order[]
  inventory        InventoryItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// SellerProfile สำหรับ KYC และรับเงิน
model SellerProfile {
  id            String    @id @default(cuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id])

  // ข้อมูลส่วนตัว (KYC)
  realName      String?   // ชื่อจริงตามบัตร
  idCardNumber  String?   // เลขบัตรประชาชน
  address       String?   // ที่อยู่
  
  // หลักฐาน (เก็บ URL รูปภาพ)
  idCardImage   String?   
  bookBankImage String?

  // ข้อมูลธนาคาร
  bankName      String?   // SCB, KBANK
  bankAccount   String?   

  // สถานะการตรวจสอบ: "PENDING", "APPROVED", "REJECTED"
  status        String    @default("PENDING") 
  rejectReason  String?   

  // ✅ Marketplace Relations (เพิ่มใหม่)
  products      Product[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// ✅ Model มาตรฐานสำหรับ NextAuth (Account)
model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String? 
  access_token       String? 
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String? 
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

// ✅ Model มาตรฐานสำหรับ NextAuth (Session)
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ✅ Model มาตรฐานสำหรับ NextAuth (VerificationToken)
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// --- CAMPAIGN TEMPLATE (สินค้า/ต้นฉบับ) ---
model Campaign {
  id          String   @id @default(cuid())
  
  // Basic Info
  title       String
  description String? 
  coverImage  String?
  tags        String? 
  
  // Game System: "STANDARD", "ROLE_AND_ROLL"
  system      String   @default("STANDARD") 

  // Story Details
  storyIntro  String? 
  storyMid    String? 
  storyEnd    String? 

  // AI Game Master Configuration
  aiEnabled      Boolean  @default(false)
  aiName         String?  @default("The Narrator")
  aiPersonality  String?  // นิสัย AI (เช่น ดุดัน, ตลก)
  aiStyle        String?  // สไตล์การเล่าเรื่อง
  aiCustomPrompt String?  // System Prompt Override

  // Marketplace Fields
  isPublished Boolean  @default(false)
  price       Int      @default(0) 
  
  // Assets
  scenes      Scene[]
  npcs        Npc[]
  items       Item[]
  preGens     PreGenCharacter[] 
  
  // Relations
  creatorId   String
  creator     User      @relation(fields: [creatorId], references: [id])
  purchases   Purchase[]
  sessions    GameSession[]
  reviews     Review[]  // Campaign reviews

  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
}

// --- ASSETS ---
model Scene {
  id          String   @id @default(cuid())
  name        String
  imageUrl    String
  description String?
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

model Npc {
  id          String   @id @default(cuid())
  name        String
  avatarUrl   String
  type        String    // FRIENDLY, ENEMY, NEUTRAL
  stats       String?   // JSON string { hp: 10, str: 10 ... }
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

model Item {
  id          String   @id @default(cuid())
  name        String
  description String?
  type        String    // WEAPON, POTION, KEY_ITEM
  icon        String?
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

model PreGenCharacter {
  id          String   @id @default(cuid())
  name        String
  bio         String?
  avatarUrl   String?
  sheetType   String   @default("STANDARD")
  stats       String?   // JSON string
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

// --- MARKETPLACE TRANSACTION ---
model Purchase {
  id          String   @id @default(cuid())
  userId      String
  campaignId  String
  purchasedAt DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id])
  campaign    Campaign @relation(fields: [campaignId], references: [id])

  @@unique([userId, campaignId]) 
}

// --- GAME SESSION (ห้องเล่นจริง) ---
model GameSession {
  id              String   @id @default(cuid())
  joinCode        String   @unique 
  status          String   @default("WAITING") 
  
  // Current State
  currentSceneId  String?
  activeNpcs      String?  // JSON Array String
  
  // Lobby Settings
  isAiGm          Boolean  @default(false)

  // Campaign 
  campaignId      String?
  campaign        Campaign? @relation(fields: [campaignId], references: [id])
  
  players         Player[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now()) @updatedAt
}

model Player {
  id            String      @id @default(cuid())
  name          String
  role          String      @default("PLAYER")
  isReady       Boolean     @default(false)
  sheetType     String      @default("STANDARD")
  
  characterData String?     
  preGenId      String?
  
  sessionId     String
  session       GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  createdAt     DateTime    @default(now()) 
}

// --- REVIEWS & FEEDBACK ---
model Review {
  id              String   @id @default(cuid())
  reviewType      String   @default("GM") // 'GM' or 'CAMPAIGN'
  rating          Int      // 0-5
  comment         String?
  reviewerName    String   
  
  // เชื่อมกับ GM (User)
  targetUserId    String?
  targetUser      User?    @relation(fields: [targetUserId], references: [id])
  
  // เชื่อมกับ Campaign
  campaignId      String?
  campaign        Campaign? @relation(fields: [campaignId], references: [id])

  sessionCode     String?

  createdAt       DateTime @default(now())
}

// --- MARKETPLACE & ASSETS (SQLite Compatible) ---

model Product {
  id          String   @id @default(cuid())
  sellerId    String
  seller      SellerProfile @relation(fields: [sellerId], references: [id])
  
  name        String
  description String?  // SQLite ไม่ต้องใช้ @db.Text
  price       Int      @default(0) // ราคา (Coins)
  
  // Type: "ITEM", "CHARACTER_ART", "SCENE_ART", "AUDIO", "RULESET"
  type        String   @default("ITEM") 
  
  // Images: เก็บเป็น JSON String หรือ URL เดี่ยวๆ เพราะ SQLite ไม่มี Array
  images      String? 
  
  fileUrl     String?  // URL ไฟล์จริง (สำหรับ Download/Use)
  
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  orderItems  OrderItem[]
  inventoryItems InventoryItem[] 
}

model Order {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id])
  
  total     Int
  
  // Status: "PENDING", "COMPLETED", "FAILED", "REFUNDED"
  status    String    @default("COMPLETED")
  
  items     OrderItem[]
  
  createdAt DateTime  @default(now())
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id])
  
  productId String
  product   Product @relation(fields: [productId], references: [id])
  
  price     Int     // ราคา ณ ตอนที่ซื้อ
}

// เก็บว่าใครมีของอะไรบ้าง (Inventory)
model InventoryItem {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  
  acquiredAt DateTime @default(now())
  
  // Custom Data สำหรับไอเทมชิ้นนี้ (เช่น ตีบวก, ใส่ชื่อเฉพาะ)
  customName String?
  quantity   Int      @default(1)

  @@unique([userId, productId]) 
}