// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql" // *** ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å sqlite ‡πÄ‡∏õ‡πá‡∏ô postgresql ***
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// --- USER & AUTH (Modified for NextAuth) ---
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?   // ‡∏£‡∏π‡∏õ Profile ‡∏à‡∏≤‡∏Å Google
  
  // Role: "USER", "GM", "ADMIN"
  role          String    @default("USER")

  // ‚úÖ Ban feature
  bannedUntil   DateTime? 
  banReason     String?   

  // NextAuth Relations
  accounts      Account[]
  sessions      Session[]

  // App Specific Relations
  createdCampaigns Campaign[] 
  ownedCampaigns   Purchase[] 
  receivedReviews  Review[]
  
  // Seller Profile (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô/‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á)
  sellerProfile    SellerProfile?

  // ‚úÖ Marketplace Relations
  orders           Order[]
  inventory        InventoryItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  marketplaceItems MarketplaceItem[] @relation("UserMarketplaceItems") // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
  transactions     Transaction[] // ChillPay transactions
}

// SellerProfile ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö KYC ‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô
model SellerProfile {
  id            String    @id @default(cuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id])

  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (KYC)
  realName      String?   
  idCardNumber  String?   
  address       String?   
  
  // ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô (‡πÄ‡∏Å‡πá‡∏ö URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û)
  idCardImage   String?   
  bookBankImage String?

  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£
  bankName      String?   
  bankAccount   String?   

  // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: "PENDING", "APPROVED", "REJECTED"
  status        String    @default("PENDING") 
  rejectReason  String?   

  products      Product[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// ‚úÖ Model ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö NextAuth (Account)
model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String? 
  access_token       String? 
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String? 
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

// ‚úÖ Model ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö NextAuth (Session)
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ‚úÖ Model ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö NextAuth (VerificationToken)
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// --- CAMPAIGN TEMPLATE (‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö) ---
model Campaign {
  id          String   @id @default(cuid())
  
  // Basic Info
  title       String
  description String? 
  coverImage  String?
  tags        String? 
  
  // Game System: "STANDARD", "ROLE_AND_ROLL"
  system      String   @default("STANDARD") 

  // Story Details
  storyIntro  String? 
  storyMid    String? 
  storyEnd    String? 

  // AI Game Master Configuration
  aiEnabled      Boolean  @default(false)
  aiName         String?  @default("The Narrator")
  aiPersonality  String?  
  aiStyle        String?  
  aiCustomPrompt String?  

  // Marketplace Fields
  isPublished Boolean  @default(false)
  price       Int      @default(0) 
  
  // Assets
  scenes      Scene[]
  npcs        Npc[]
  items       Item[]
  preGens     PreGenCharacter[] 
  
  // Relations
  creatorId   String
  creator     User      @relation(fields: [creatorId], references: [id])
  purchases   Purchase[]
  sessions    GameSession[]
  reviews     Review[] 

  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
}

// --- ASSETS ---
model Scene {
  id          String   @id @default(cuid())
  name        String
  imageUrl    String
  description String?
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

model Npc {
  id          String   @id @default(cuid())
  name        String
  avatarUrl   String
  type        String    // FRIENDLY, ENEMY, NEUTRAL
  stats       String?   // JSON string { hp: 10, str: 10 ... }
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

model Item {
  id          String   @id @default(cuid())
  name        String
  description String?
  type        String    // WEAPON, POTION, KEY_ITEM
  icon        String?
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

model PreGenCharacter {
  id          String   @id @default(cuid())
  name        String
  bio         String?
  avatarUrl   String?
  sheetType   String   @default("STANDARD")
  stats       String?   // JSON string
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

// --- MARKETPLACE TRANSACTION ---
model Purchase {
  id          String   @id @default(cuid())
  userId      String
  campaignId  String
  purchasedAt DateTime @default(now())
  price       Float    @default(0) // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ

  user        User     @relation(fields: [userId], references: [id])
  campaign    Campaign @relation(fields: [campaignId], references: [id])

  @@unique([userId, campaignId]) 
}

// --- GAME SESSION (‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏£‡∏¥‡∏á) ---
model GameSession {
  id              String    @id @default(cuid())
  joinCode        String    @unique 
  status          String    @default("WAITING") 
  name            String?   @default("Untitled Session")
  
  // Current State
  currentSceneId  String?
  activeNpcs      String?   // JSON Array String (NPC ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏ä‡∏ß‡πå)
  
  // Lobby Settings
  isAiGm          Boolean  @default(false)

  // ‚úÖ Quick Add Assets (‡πÉ‡∏ä‡πâ Custom ‡πÅ‡∏ó‡∏ô Temp ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô)
  customScenes    String?  // JSON Array: [{ id, name, imageUrl }]
  customNpcs      String?  // JSON Array: [{ id, name, imageUrl }]

  // Campaign 
  campaignId      String?
  campaign        Campaign? @relation(fields: [campaignId], references: [id])
  
  players         Player[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now()) @updatedAt
}

model Player {
  id            String      @id @default(cuid())
  name          String
  role          String      @default("PLAYER")
  isReady       Boolean     @default(false)
  sheetType     String      @default("STANDARD")
  
  characterData String?      
  preGenId      String?
  
  sessionId     String
  session       GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  createdAt     DateTime    @default(now()) 
}

// --- REVIEWS & FEEDBACK ---
model Review {
  id            String   @id @default(cuid())
  reviewType    String   @default("GM") // 'GM' or 'CAMPAIGN'
  rating        Int      
  comment       String?
  reviewerName  String   
  
  targetUserId  String?
  targetUser    User?    @relation(fields: [targetUserId], references: [id])
  
  campaignId    String?
  campaign      Campaign? @relation(fields: [campaignId], references: [id])

  sessionCode   String?

  createdAt     DateTime @default(now())
}

// --- MARKETPLACE & ASSETS (For Individual Items/Products) ---

model Product {
  id          String   @id @default(cuid())
  sellerId    String
  seller      SellerProfile @relation(fields: [sellerId], references: [id])
  
  name        String
  description String?  
  price       Int      @default(0) 
  
  type        String   @default("ITEM") 
  images      String?  
  fileUrl     String?  
  
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  orderItems  OrderItem[]
  inventoryItems InventoryItem[] 
}

model Order {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id])
  
  total     Int
  status    String    @default("COMPLETED")
  
  items     OrderItem[]
  
  createdAt DateTime  @default(now())
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id])
  
  productId String
  product   Product @relation(fields: [productId], references: [id])
  
  price     Int     
}

model InventoryItem {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  
  acquiredAt  DateTime @default(now())
  customName  String?
  quantity    Int      @default(1)

  @@unique([userId, productId]) 
}

// --- MARKETPLACE ITEM (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö API) ---
model MarketplaceItem {
  id          String   @id @default(cuid())
  title       String
  description String?
  type        String
  price       Float    @default(0)
  creatorId   String
  isPublished Boolean  @default(true)
  data        String   // ‡πÄ‡∏Å‡πá‡∏ö JSON String (imageUrl, tags) ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô API
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  creator     User     @relation("UserMarketplaceItems", fields: [creatorId], references: [id])
}

// Transaction Model - Polymorphic design for multiple product types
model Transaction {
  id            String   @id @default(cuid())
  orderNo       String   @unique // ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ ChillPay
  amount        Int      // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)
  status        String   @default("PENDING") // PENDING, SUCCESS, FAILED, REFUNDED
  
  // User who made the purchase
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  
  // üî• Polymorphic Fields - ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
  itemType      String?  // "CAMPAIGN", "GM_QUEUE", "ASSET", "MARKETPLACE_ITEM"
  itemId        String?  // ID ‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
  
  // Metadata (‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏õ‡πá‡∏ô JSON)
  metadata      Json?    // { itemName, itemPrice, quantity, etc. }
  
  // Stripe specific fields
  stripeSessionId     String?  @unique // Stripe Checkout Session ID
  stripePaymentIntent String?  // Stripe Payment Intent ID
  paymentDate         DateTime?
  paymentMethod       String?  // "card", "promptpay", etc.
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([userId])
  @@index([itemType, itemId])
  @@index([status])
}
