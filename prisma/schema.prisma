generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id               String            @id @default(cuid())
  name             String?
  email            String?           @unique
  emailVerified    DateTime?
  image            String?
  role             String            @default("USER")
  bannedUntil      DateTime?
  banReason        String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  accounts         Account[]
  createdCampaigns Campaign[]
  inventory        InventoryItem[]
  marketplaceItems MarketplaceItem[] @relation("UserMarketplaceItems")
  orders           Order[]
  ownedCampaigns   Purchase[]
  receivedReviews  Review[]
  sellerProfile    SellerProfile?
  sessions         Session[]
  transactions     Transaction[]
}

model SellerProfile {
  id            String    @id @default(cuid())
  userId        String    @unique
  realName      String?
  idCardNumber  String?
  address       String?
  idCardImage   String?
  bookBankImage String?
  bankName      String?
  bankAccount   String?
  status        String    @default("PENDING")
  rejectReason  String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  products      Product[]
  user          User      @relation(fields: [userId], references: [id])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Campaign {
  id             String            @id @default(cuid())
  title          String
  description    String?
  coverImage     String?
  tags           String?
  system         String            @default("STANDARD")
  storyIntro     String?
  storyMid       String?
  storyEnd       String?
  aiEnabled      Boolean           @default(false)
  aiName         String?           @default("The Narrator")
  aiPersonality  String?
  aiStyle        String?
  aiCustomPrompt String?
  isPublished    Boolean           @default(false)
  price          Int               @default(0)
  creatorId      String
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @default(now()) @updatedAt
  creator        User              @relation(fields: [creatorId], references: [id])
  sessions       GameSession[]
  items          Item[]
  npcs           Npc[]
  preGens        PreGenCharacter[]
  purchases      Purchase[]
  reviews        Review[]
  scenes         Scene[]
}

model Scene {
  id          String   @id @default(cuid())
  name        String
  imageUrl    String
  description String?
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

model Npc {
  id         String   @id @default(cuid())
  name       String
  avatarUrl  String
  type       String
  stats      String?
  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

model Item {
  id          String   @id @default(cuid())
  name        String
  description String?
  type        String
  icon        String?
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

model PreGenCharacter {
  id         String   @id @default(cuid())
  name       String
  bio        String?
  avatarUrl  String?
  sheetType  String   @default("STANDARD")
  stats      String?
  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

model Purchase {
  id          String   @id @default(cuid())
  userId      String
  campaignId  String
  purchasedAt DateTime @default(now())
  price       Float    @default(0)
  campaign    Campaign @relation(fields: [campaignId], references: [id])
  user        User     @relation(fields: [userId], references: [id])

  @@unique([userId, campaignId])
}

model GameSession {
  id             String    @id @default(cuid())
  joinCode       String    @unique
  status         String    @default("WAITING")
  name           String?   @default("Untitled Session")
  currentSceneId String?
  activeNpcs     String?
  isAiGm         Boolean   @default(false)
  customScenes   String?
  customNpcs     String?
  campaignId     String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @default(now()) @updatedAt
  campaign       Campaign? @relation(fields: [campaignId], references: [id])
  players        Player[]
}

model Player {
  id            String      @id @default(cuid())
  name          String
  role          String      @default("PLAYER")
  isReady       Boolean     @default(false)
  sheetType     String      @default("STANDARD")
  characterData String?
  preGenId      String?
  sessionId     String
  createdAt     DateTime    @default(now())
  session       GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

model Review {
  id           String    @id @default(cuid())
  reviewType   String    @default("GM")
  rating       Int
  comment      String?
  reviewerName String
  targetUserId String?
  campaignId   String?
  sessionCode  String?
  createdAt    DateTime  @default(now())
  campaign     Campaign? @relation(fields: [campaignId], references: [id])
  targetUser   User?     @relation(fields: [targetUserId], references: [id])
}

model Product {
  id             String          @id @default(cuid())
  sellerId       String
  name           String
  description    String?
  price          Int             @default(0)
  type           String          @default("ITEM")
  images         String?
  fileUrl        String?
  isPublished    Boolean         @default(false)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  inventoryItems InventoryItem[]
  orderItems     OrderItem[]
  seller         SellerProfile   @relation(fields: [sellerId], references: [id])
}

model Order {
  id        String      @id @default(cuid())
  userId    String
  total     Int
  status    String      @default("COMPLETED")
  createdAt DateTime    @default(now())
  user      User        @relation(fields: [userId], references: [id])
  items     OrderItem[]
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  productId String
  price     Int
  order     Order   @relation(fields: [orderId], references: [id])
  product   Product @relation(fields: [productId], references: [id])
}

model InventoryItem {
  id         String   @id @default(cuid())
  userId     String
  productId  String
  acquiredAt DateTime @default(now())
  customName String?
  quantity   Int      @default(1)
  product    Product  @relation(fields: [productId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@unique([userId, productId])
}

model MarketplaceItem {
  id          String   @id @default(cuid())
  title       String
  description String?
  type        String
  price       Float    @default(0)
  creatorId   String
  isPublished Boolean  @default(true)
  data        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  creator     User     @relation("UserMarketplaceItems", fields: [creatorId], references: [id])
}

model Transaction {
  id                  String    @id @default(cuid())
  orderNo             String    @unique
  amount              Int
  status              String    @default("PENDING")
  userId              String
  itemType            String?
  itemId              String?
  metadata            Json?
  stripeSessionId     String?   @unique
  stripePaymentIntent String?
  paymentDate         DateTime?
  paymentMethod       String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  user                User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([itemType, itemId])
  @@index([status])
}

model SiteConfig {
  id           Int      @id @default(1)
  heroTitle    String   @default("Welcome, Traveler")
  heroSubtitle String   @default("Your adventure begins here. Choose your destiny.")
  heroImageUrl String?
  announcement String?
  updatedAt    DateTime
}
