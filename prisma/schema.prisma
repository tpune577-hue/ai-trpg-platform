// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// --- USER & AUTH ---
model User {
  id             String     @id @default(cuid())
  email          String     @unique
  name           String?
  
  // Relation: เกมที่สร้างเอง (ในฐานะ Creator/GM)
  createdCampaigns Campaign[] 
  
  // Relation: เกมที่ซื้อมา
  ownedCampaigns   Purchase[] 
  
  // Relation: รีวิวที่ได้รับ (ในฐานะ GM)
  receivedReviews  Review[]
}

// --- CAMPAIGN TEMPLATE (สินค้า/ต้นฉบับ) ---
model Campaign {
  id          String   @id @default(cuid())
  title       String
  description String? 
  coverImage  String?
  tags        String? 
  
  // Story Details
  storyIntro  String? 
  storyMid    String? 
  storyEnd    String? 

  // Marketplace Fields
  isPublished Boolean  @default(false)
  price       Int      @default(0) 
  
  // Assets
  scenes      Scene[]
  npcs        Npc[]
  items       Item[]
  preGens     PreGenCharacter[] 
  
  // Relations
  creatorId   String
  creator     User     @relation(fields: [creatorId], references: [id])
  purchases   Purchase[]
  sessions    GameSession[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
}

// --- ASSETS ---
model Scene {
  id          String   @id @default(cuid())
  name        String
  imageUrl    String
  description String?
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

model Npc {
  id          String   @id @default(cuid())
  name        String
  avatarUrl   String
  type        String    // FRIENDLY, ENEMY, NEUTRAL
  stats       String?   // JSON string { hp: 10, str: 10 ... }
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

model Item {
  id          String   @id @default(cuid())
  name        String
  description String?
  type        String    // WEAPON, POTION, KEY_ITEM
  icon        String?
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

model PreGenCharacter {
  id          String   @id @default(cuid())
  name        String
  bio         String?
  avatarUrl   String?
  
  // ✅ เพิ่ม sheetType: เพื่อรองรับการสร้าง Pre-Gen แบบ Role & Roll
  sheetType   String   @default("STANDARD") // "STANDARD", "ROLE_AND_ROLL"
  
  stats       String?   // JSON string (Character Sheet Data)
  
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

// --- MARKETPLACE TRANSACTION ---
model Purchase {
  id          String   @id @default(cuid())
  userId      String
  campaignId  String
  purchasedAt DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id])
  campaign    Campaign @relation(fields: [campaignId], references: [id])

  @@unique([userId, campaignId]) 
}

// --- GAME SESSION (ห้องเล่นจริง) ---
model GameSession {
  id             String   @id @default(cuid())
  joinCode       String   @unique 
  status         String   @default("WAITING") // WAITING, ACTIVE, PAUSED, ENDED
  
  // Current State
  currentSceneId String?
  activeNpcs     String?  // JSON Array String
  
  // Lobby Settings
  isAiGm         Boolean  @default(false)

  // Campaign 
  campaignId     String?
  campaign       Campaign? @relation(fields: [campaignId], references: [id])
  
  players        Player[]
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @default(now()) @updatedAt
}

model Player {
  id            String      @id @default(cuid())
  name          String
  role          String      @default("PLAYER") // GM, PLAYER
  isReady       Boolean     @default(false)
  
  // ✅ เพิ่ม sheetType: เพื่อบอกว่า Player คนนี้ใช้หน้าจอแบบไหน
  sheetType     String      @default("STANDARD") // "STANDARD", "ROLE_AND_ROLL"
  
  characterData String?     // JSON String (HP, Stats, Inventory)
  preGenId      String?
  
  sessionId     String
  session       GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  createdAt     DateTime    @default(now()) 
}

// --- REVIEWS & FEEDBACK ---
model Review {
  id           String   @id @default(cuid())
  rating       Int      // 0-5
  comment      String?
  reviewerName String   // ชื่อ Player ที่รีวิว
  
  // เชื่อมกับ GM (User)
  targetUserId String
  targetUser   User     @relation(fields: [targetUserId], references: [id])

  // เก็บว่ามาจาก Session ไหน (Optional)
  sessionCode  String?

  createdAt    DateTime @default(now())
}